{% extends "base.html" %}
{% load planner_tags %}
{% load static %}
{% block title %}StudyFly - Horarios{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/optimizer.css' %}" />
<link rel="stylesheet" href="{% static 'css/horarios.css' %}" />
{% endblock %}
{% block content %}
<div class="calendar-container">
  <!-- Header del Calendario -->
  <div class="calendar-header">
    <div class="month-year">
      <span>{{ current_month_name|capfirst }}</span>
      <span>{{ current_week_range }}</span>
    </div>
    <div class="view-toggle">
      <div class="week-navigation">
        <a href="?direction=prev&date={{ start_of_week.isoformat }}" class="nav-btn">‚Üê Semana Anterior</a>
        <a href="?direction=current" class="nav-btn">Hoy</a>
        <a href="?direction=next&date={{ start_of_week.isoformat }}" class="nav-btn">Semana Siguiente ‚Üí</a>
      </div>
      <button class="toggle-btn optimize-btn">ü§ñ Optimizar Horario</button>
      <a href="{% url 'planner:event_create' %}" class="toggle-btn active">Agregar Tarea</a>
    </div>
  </div>

  <!-- Tabla del Calendario -->
  <div class="calendar-table-wrapper">
    <table class="calendar-table">
      <thead>
        <tr>
          <th class="time-column-header"></th>
          {% for day_data in week_days_data %}
          <th class="day-header {% if day_data.is_today %}today{% endif %}">
            <div>{{ day_data.day_num }}</div>
            <div>{{ day_data.day_name_short|capfirst }}</div>
          </th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for hour_slot in time_slots %}
        <tr>
          <td class="time-slot">{{ hour_slot }}</td>
          {% for day_data in week_days_data %}
          <td class="day-cell {% if day_data.is_today %}today{% endif %}" data-day-index="{{ day_data.date.weekday }}">
            <div class="day-events-container">
              {% for event in events_by_day|get_item:day_data.date.weekday|get_item:hour_slot %}
              {% if not event.is_continuation %}
              <a
                href="{% url 'planner:event_detail' event.id %}"
                class="event {{ event.css_class }}{% if event.is_completed %} completed{% endif %}{% if event.due_date and event.due_date < today and not event.is_completed %} overdue{% endif %}"
                data-event-id="{{ event.id }}"
                data-priority="{{ event.priority }}"
                title="{{ event.title }} - {{ event.start_time|date:'H:i' }} a {{ event.end_time|date:'H:i' }}"
              >
                <div class="event-title">{{ event.title }}</div>
                <div class="event-time">{{ event.start_time|date:"H:i" }} - {{ event.end_time|date:"H:i" }}</div>
                {% if event.description and event.description|length > 0 %}
                <div class="event-description">{{ event.description|truncatechars:30 }}</div>
                {% endif %}
                <div class="custom-tooltip">
                  <strong>{{ event.title }}</strong><br />
                  {{ event.start_time|date:"H:i" }} - {{ event.end_time|date:"H:i" }}<br />
                  {% if event.description %}{{ event.description|truncatechars:50 }}{% endif %}
                </div>
              </a>
              {% else %}
              <div
                class="event {{ event.css_class }} event-continuation{% if event.is_completed %} completed{% endif %}{% if event.due_date and event.due_date < today and not event.is_completed %} overdue{% endif %}"
                data-event-id="{{ event.id }}"
              >
                <div class="event-continuation-text">Contin√∫a: {{ event.title }}</div>
              </div>
              {% endif %}
              {% endfor %}
            </div>
          </td>
          {% endfor %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Leyenda de Categor√≠as -->
  <div class="categories">
    <div class="category">
      <div class="category-dot event-tarea"></div>
      <span>Tareas/Estudio</span>
    </div>
    <div class="category">
      <div class="category-dot event-clase"></div>
      <span>Clases/Acad√©mico</span>
    </div>
    <div class="category">
      <div class="category-dot event-descanso"></div>
      <span>Descansos</span>
    </div>
    <div class="category">
      <div class="category-dot event-personal"></div>
      <span>Personal</span>
    </div>
    <div class="category">
      <div class="category-dot event-otro"></div>
      <span>Otro</span>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const todayCell = document.querySelector(".day-cell.today");
    if (todayCell) {
      const currentHour = new Date().getHours();
      const scrollPosition = Math.max(0, (currentHour - 2) * 50);
      document.querySelector(".calendar-table-wrapper").scrollTop = scrollPosition;
    }
  });
</script>
{% endblock %}
{% block extra_js %}
<script src="{% static 'js/optimizer.js' %}"></script>
<script src="{% static 'js/calendar.js' %}"></script>
{% endblock %}  