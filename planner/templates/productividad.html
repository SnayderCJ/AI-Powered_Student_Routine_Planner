{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/productividad.css' %}">
{% endblock %}

{% block content %}
<main class="main-content">
  <link rel="stylesheet" href="{% static 'css/productividad.css' %}">
  <section class="productividad-container">

    <h2><span style="color: #fff;">An√°lisis De</span> <span style="color: #A259FF;">Productividad</span></h2>

    <!-- Panel principal: Barras + Donut + Indicadores -->
    <div class="fila-arriba">
      <div class="grafico-barras card">
        <canvas id="graficoProductividad"></canvas>
      </div>
      
      <div class="columna-derecha">
        <div class="donut-card">
          <div class="donut-container">
            <canvas id="donutChart"></canvas>
            <div class="donut-text">
              <div id="donutPorcentaje">
                <div class="valor">100%</div>
                <div class="etiqueta">Productividad</div>
              </div>
            </div>
          </div>
        </div>

        <div class="indicadores">
          <!--<p><strong>{{ productividad_hoy }}%</strong> Progreso</p>-->
          <p class="{% if dif_ayer_positivo %}positivo{% else %}negativo{% endif %}">
            {{ dif_ayer_valor }}% {% if dif_ayer_positivo %}m√°s{% else %}menos{% endif %} productivo que ayer
          </p>
          <p class="{% if dif_promedio_positivo %}positivo{% else %}negativo{% endif %}">
            {{ dif_promedio_valor }}% {% if dif_promedio_positivo %}m√°s{% else %}menos{% endif %} que tu promedio semanal
          </p>
        </div>
      </div>
    </div>

    <!-- Patrones -->
    <div class="patrones card">
      <h3>üß† <span style="color: #fff;">Patrones</span> <span style="color: #A259FF;">Identificados</span></h3>
      <ul>
        <li>üìÖ Tu d√≠a m√°s productivo es: <strong>{{ dia_productivo }}</strong></li>
        <li>üïí Mayor rendimiento del d√≠a: <strong>{{ mejor_rango }}</strong></li>
      </ul>
    </div>

  </section>
</main>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  const dataProductividad = {{ productividad_dias|safe }};
  const ctx = document.getElementById('graficoProductividad').getContext('2d');
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'],
      datasets: [{
        label: 'Nivel de Productividad',
        data: dataProductividad,
        backgroundColor: ['#6EE7B7', '#3B82F6', '#818CF8', '#A78BFA', '#F472B6', '#FBBF24', '#F87171'],
        borderRadius: 6,
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: {
        y: { beginAtZero: true, ticks: { color: '#ddd' } },
        x: { ticks: { color: '#ddd' } }
      }
    }
  });

  const productividad_real = {{ productividad_hoy }};
  const porcentaje_donut = Math.min(100, productividad_real);
  const restante = 100 - porcentaje_donut;

  // Donut grande din√°mico
  new Chart(document.getElementById("donutChart").getContext("2d"), {
    type: 'doughnut',
    data: {
      labels: ['Productivo', 'Restante'],
      datasets: [{
        data: [porcentaje_donut, restante], 
        backgroundColor: ['#A259FF', '#3f3f46'],
        borderWidth: 0,
        cutout: '75%',
      }]
    },
    options: {
      responsive: false, // o true, dependiendo
      plugins: { legend: { display: false } },
      animation: {
        animateRotate: true,
        duration: 1000,
        onProgress: function(animation) {
          const progress = animation.currentStep / animation.numSteps;
          const porcentajeAnimado = Math.round(porcentaje_donut * progress);

          const donutTexto = document.getElementById("donutPorcentaje");
          donutTexto.innerHTML = `
            <div class="valor">${porcentajeAnimado}%</div>
            <div class="etiqueta">Productividad</div>
          `;

          // Colores seg√∫n porcentaje
          const color = porcentajeAnimado < 50 ? '#ef4444'
                      : porcentajeAnimado < 80 ? '#facc15'
                      : '#22c55e';

          donutTexto.querySelector('.valor').style.color = color;
        }

      },
      plugins: { legend: { display: false } }
    }
  });

});
</script>
{% endblock %}
