{% extends 'base.html' %}
{% load static %}
{% block content %}

<link rel="stylesheet" href="{% static 'css/bloques_enfocados.css' %}">

<div class="bloques-layout">
  
  <!-- BLOQUES IA -->
  <div class="bloques-tabla">
    <h2 class="seccion-titulo">Bloques de Tiempo Enfocado</h2>
    <div class="tabla-scroll">
      <table class="tabla-bloques">
        <thead>
          <tr>
            <!-- <th>Hora</th>-->
            {% with "LMXJVSD" as letras_dias %}
              {% for letra in letras_dias|make_list %}
                {% if forloop.counter0 == 0 %}<th>Lun</th>{% endif %}
                {% if forloop.counter0 == 1 %}<th>Mar</th>{% endif %}
                {% if forloop.counter0 == 2 %}<th>Mi√©</th>{% endif %}
                {% if forloop.counter0 == 3 %}<th>Jue</th>{% endif %}
                {% if forloop.counter0 == 4 %}<th>Vie</th>{% endif %}
                {% if forloop.counter0 == 5 %}<th>S√°b</th>{% endif %}
                {% if forloop.counter0 == 6 %}<th>Dom</th>{% endif %}
              {% endfor %}
            {% endwith %}
          </tr>
        </thead>
         <tbody>
          {% for hora in horas %}
            <tr>
              <!-- <td>{{ hora }}</td>-->
              {% for i in "0123456"|make_list %}
                <td>
                  {% for bloque in bloques %}
                    {% if bloque.start_time|time:"H:i" == hora and bloque.weekday|stringformat:"i" == i %}
                      {% if bloque.event_type == 'bloque_estudio' or bloque.event_type == 'descanso_recomendado' or bloque.event_type == 'descanso_real' or bloque.event_type == 'otro' %}
                        <div class="bloque
                            {% if bloque.event_type == 'bloque_estudio' %}bloque-real{% endif %}
                            {% if bloque.event_type == 'descanso_recomendado' %}bloque-descanso-recomendado{% endif %}
                            {% if bloque.event_type == 'descanso_real' %}bloque-descanso{% endif %}
                            {% if bloque.event_type == 'otro' %}bloque-real{% endif %}">
                          {{ bloque.title }}<br>
                          {{ bloque.start_time|time:"H:i" }} - {{ bloque.end_time|time:"H:i" }}
                        </div>
                      {% endif %}
                    {% endif %}
                  {% endfor %}

                </td>

              {% endfor %}
            </tr>
          {% endfor %}
        </tbody>

      </table>
    </div>
  </div>


    <!-- AGRUPACI√ìN DE TEMPORIZADOR Y CONFIGURACI√ìN -->
  <div class="bloque-temporizador">
    <div class="temporizador">
      <h2 class="seccion-titulo">Tiempo de Enfoque</h2>
      <div id="temporizador">25:00</div>
      <p id="objetivo-actual" style="margin-top: 10px; font-size: 1.1rem;"></p>
      <div class="botones">
        <button onclick="iniciarPomodoro()">Iniciar</button>
        <button onclick="pausarPomodoro()">Pausar</button>
        <button onclick="reiniciarPomodoro()">Reiniciar</button>
      </div>
    </div>

    <div class="configuracion-rapida espacio-ajustado">
      <h3>Configuraci√≥n r√°pida</h3>
      <form onsubmit="return false;">
        <label>Duraci√≥n del enfoque (min):</label>
        <input type="number" name="duracion_enfoque" id="inputEnfoque" value="25">

        <label>Objetivo del bloque:</label>
        <input type="text" name="objetivo" id="inputObjetivo" placeholder="Ej: Estudiar √°lgebra">

        <button type="button" onclick="aplicarConfiguracion()">Aplicar</button>
      </form>
    </div>


  <!-- ESTAD√çSTICAS -->
    <div class="resumen-hoy">
        <h3>Bloques Completados hoy:</h3>
        <ul id="resumen-productividad">
          <li class="logro">‚úÖ 0 bloques completados hoy</li>
          <li class="logro">‚è±Ô∏è Tiempo Acumulado: 0m</li>
        </ul>
    </div>
</div>


<script>
  let tiempo = 25 * 60;
  let enMarcha = false;
  let intervalo;
  let bloquesCompletados = 0;
  let minutosAcumulados = 0;

  function actualizarTemporizador() {
    const min = Math.floor(tiempo / 60).toString().padStart(2, '0');
    const seg = (tiempo % 60).toString().padStart(2, '0');
    document.getElementById("temporizador").textContent = `${min}:${seg}`;
  }

  function aplicarConfiguracion() {
    const minutos = parseInt(document.getElementById("inputEnfoque").value) || 25;
    const objetivo = document.getElementById("inputObjetivo").value;

    tiempo = minutos * 60;
    actualizarTemporizador();

    document.getElementById("objetivo-actual").textContent = objetivo ? `üéØ ${objetivo}` : "";
  }

  function iniciarPomodoro() {
    if (!enMarcha) {
      enMarcha = true;
      intervalo = setInterval(() => {
        if (tiempo > 0) {
          tiempo--;
          actualizarTemporizador();
        } else {
          clearInterval(intervalo);
          enMarcha = false;

          alert("¬°Bloque completado!");

          // 1. Obtener duraci√≥n actual
          const enfoqueMin = parseInt(document.getElementById("inputEnfoque").value) || 25;

          // 2. Sumar a contadores
          if (enfoqueMin >= 25) {
            bloquesCompletados++;
          } else {
            alert("Este bloque fue muy corto para contarse como completo (menos de 25 min).");
          }
          
          // ‚è±Ô∏è Siempre sumar al tiempo acumulado
          minutosAcumulados += enfoqueMin;

          // 3. Actualizar resumen
          actualizarResumenProductividad();
        }
      }, 1000);
    }
  }

  function pausarPomodoro() {
    clearInterval(intervalo);
    enMarcha = false;
  }

  function reiniciarPomodoro() {
    clearInterval(intervalo);
    tiempo = 25 * 60;
    actualizarTemporizador();
    enMarcha = false;
    document.getElementById("objetivo-actual").textContent = "";
  }

  function actualizarResumenProductividad() {
    const resumen = document.getElementById("resumen-productividad");
    const tiempoTexto = minutosAcumulados >= 60
      ? `${Math.floor(minutosAcumulados / 60)}h ${minutosAcumulados % 60}m`
      : `${minutosAcumulados}m`;

    resumen.innerHTML = `
      <li class="logro">‚úÖ ${bloquesCompletados} bloques completados hoy</li>
      <li class="logro">‚è±Ô∏è Tiempo Acumulado: ${tiempoTexto}</li>
    `;
  }

  // Inicial
  actualizarTemporizador();
  actualizarResumenProductividad();
</script>

{% endblock %}

